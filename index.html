<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ°Ô∏è Bullying Detector</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="BullyGuard">
  <link rel="manifest" href="manifest.json">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }

    .container { max-width: 400px; margin: 0 auto; padding: 20px; }

    .header { text-align: center; margin-bottom: 30px; }

    .title { font-size: 2.2em; font-weight: bold; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }

    .subtitle { font-size: 1.1em; opacity: 0.9; margin-bottom: 30px; }

    .camera-section {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 30px 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .upload-area {
      border: 3px dashed rgba(255,255,255,0.5);
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .upload-area:hover, .upload-area.drag-over { border-color: #fff; background: rgba(255,255,255,0.1); }

    .upload-icon { font-size: 3em; margin-bottom: 15px; opacity: 0.8; }
    .upload-text { font-size: 1.1em; margin-bottom: 10px; }
    .upload-subtext { font-size: 0.9em; opacity: 0.7; }

    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 25px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-camera { background: linear-gradient(45deg, #ff6b6b, #ee5a52); color: white; }
    .btn-gallery { background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; }

    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .results-section {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      margin-top: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      display: none;
    }

    .results-title { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .result-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
    .result-safe { border-left: 4px solid #2ecc71; }
    .result-warning { border-left: 4px solid #f39c12; }
    .result-danger { border-left: 4px solid #e74c3c; }

    .loading { display: none; text-align: center; padding: 20px; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 4px solid white; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    .preview-image { max-width: 100%; max-height: 300px; border-radius: 10px; margin: 15px 0; }

    #file-input-camera, #file-input-gallery { display: none; }
    .status-text { text-align: center; margin-top: 15px; font-size: 0.9em; opacity: 0.8; }

    /* Install button styling */
    .install-btn {
      position: fixed; bottom: 20px; right: 20px;
      background: rgba(255,255,255,0.2);
      border: none; border-radius: 50%;
      width: 60px; height: 60px;
      font-size: 24px; cursor: pointer;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none; z-index: 1000; color: white;
    }

    /* Report form modal */
    .report-modal {
      display: none;
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .report-content {
      background: white;
      color: black;
      padding: 20px;
      border-radius: 15px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .report-content h2 { margin-bottom: 15px; font-size: 1.3em; }
    .report-content textarea {
      width: 100%; height: 120px; padding: 10px;
      border-radius: 10px; border: 1px solid #ccc;
      margin-bottom: 15px; resize: none;
    }
    .report-actions { display: flex; justify-content: space-between; gap: 10px; }
    .report-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
    .report-btn-submit { background: #e74c3c; color: white; }
    .report-btn-cancel { background: #ccc; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">üõ°Ô∏è Anti-Bullying AI</div>
      <div class="subtitle">Keep schools safe with AI technology</div>
    </div>

    <div class="camera-section">
      <div class="upload-area" id="upload-area">
        <div class="upload-icon">üì∏</div>
        <div class="upload-text">Tap to take photo or upload image</div>
        <div class="upload-subtext">JPG, PNG, WebP supported</div>
      </div>
      <input type="file" id="file-input-camera" accept="image/*" capture="environment">
      <input type="file" id="file-input-gallery" accept="image/*">

      <button class="btn btn-camera" onclick="takePhoto()">üì∑ Take Photo</button>
      <button class="btn btn-gallery" onclick="openGallery()">üñºÔ∏è Choose from Gallery</button>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>üîç Analyzing image for bullying...</div>
      <div class="status-text">This may take a few seconds</div>
    </div>

    <div class="results-section" id="results">
      <div class="results-title"><span>üìä</span><span>Detection Results</span></div>
      <div id="results-content"></div>
    </div>
  </div>

  <!-- Install button -->
  <button id="installBtn" class="install-btn">üì≤</button>

  <!-- Report Modal -->
  <div id="reportModal" class="report-modal">
    <div class="report-content">
      <h2>üì¢ Report Bullying Incident</h2>
      <textarea id="reportText" placeholder="Describe what happened..."></textarea>
      <div class="report-actions">
        <button class="report-btn report-btn-cancel" onclick="closeReport()">Cancel</button>
        <button class="report-btn report-btn-submit" onclick="submitReport()">Submit</button>
      </div>
    </div>
  </div>

  <script>
    const ROBOFLOW_API_KEY = "1RuIGDSVW5gVOPaIq5I7";
    const MODEL_ENDPOINT = "https://detect.roboflow.com/bullying-detection-lixke-xxmrf/1";
    const fileInputCamera = document.getElementById('file-input-camera');
    const fileInputGallery = document.getElementById('file-input-gallery');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const resultsContent = document.getElementById('results-content');
    const uploadArea = document.getElementById('upload-area');

    fileInputCamera.addEventListener('change', handleFileSelect);
    fileInputGallery.addEventListener('change', handleFileSelect);

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => uploadArea.addEventListener(eventName, highlight, false));
    ['dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, unhighlight, false));
    uploadArea.addEventListener('drop', handleDrop, false);

    function preventDefaults(e){ e.preventDefault(); e.stopPropagation();}
    function highlight(){ uploadArea.classList.add('drag-over');}
    function unhighlight(){ uploadArea.classList.remove('drag-over');}
    function handleDrop(e){ const dt = e.dataTransfer; if (dt.files.length > 0) handleFile(dt.files[0]); }
    function takePhoto(){ fileInputCamera.click(); }
    function openGallery(){ fileInputGallery.click(); }
    function handleFileSelect(event){ const file = event.target.files[0]; if(file){ handleFile(file); event.target.value='';}}

    function handleFile(file){
      if(!file.type.startsWith('image/')){ alert('Please select an image file'); return;}
      const reader=new FileReader();
      reader.onload=(e)=>{showPreview(e.target.result);};
      reader.readAsDataURL(file);
      analyzeImage(file);
    }

    function showPreview(imageSrc){
      const existing=document.querySelector('.preview-image'); if(existing) existing.remove();
      const img=document.createElement('img'); img.src=imageSrc; img.className='preview-image'; uploadArea.appendChild(img);
    }

    async function analyzeImage(file){
      loading.style.display='block'; results.style.display='none';
      try{
        const formData=new FormData(); formData.append('file',file);
        const controller=new AbortController(); const timeoutId=setTimeout(()=>controller.abort(),30000);
        const response=await fetch(`${MODEL_ENDPOINT}?api_key=${ROBOFLOW_API_KEY}&confidence=40&overlap=30`,{method:'POST',body:formData,signal:controller.signal});
        clearTimeout(timeoutId);
        if(!response.ok) throw new Error(`API request failed: ${response.status}`);
        const result=await response.json(); displayResults(result);
      }catch(error){
        console.error(error); displayError('Analysis failed. Please try again.');
      }finally{ loading.style.display='none';}
    }

    function displayResults(result){
      results.style.display='block'; resultsContent.innerHTML='';
      if(result.predictions && result.predictions.length>0){
        const alertDiv=document.createElement('div');
        alertDiv.className='result-item result-danger';
        alertDiv.innerHTML=`<div style="font-size:1.2em;font-weight:bold;margin-bottom:10px;">üö® BULLYING DETECTED!</div><div style="margin-bottom:15px;">Found ${result.predictions.length} potential incident(s):</div>`;
        result.predictions.forEach(pred=>{
          const confidence=Math.round(pred.confidence*100);
          const detectionDiv=document.createElement('div');
          detectionDiv.style.cssText='background:rgba(231,76,60,0.2);padding:10px;border-radius:8px;margin-bottom:8px;';
          detectionDiv.innerHTML=`<strong>${pred.class}</strong><br><span style="font-size:0.9em;">Confidence: ${confidence}%</span>`;
          alertDiv.appendChild(detectionDiv);
        });
        alertDiv.innerHTML+=`<div style="margin-top:15px;font-size:0.9em;opacity:0.9;">‚ö†Ô∏è Please report this incident to school authorities immediately.</div>`;
        resultsContent.appendChild(alertDiv);

        // Report button
        const reportButton=document.createElement('button');
        reportButton.textContent="üì¢ Report Incident";
        reportButton.className="btn btn-camera";
        reportButton.style.marginTop="10px";
        reportButton.onclick=openReport;
        resultsContent.appendChild(reportButton);
      } else {
        const safeDiv=document.createElement('div');
        safeDiv.className='result-item result-safe';
        safeDiv.innerHTML=`<div style="font-size:1.2em;font-weight:bold;margin-bottom:10px;">‚úÖ All Clear!</div><div>No signs of bullying detected.</div>`;
        resultsContent.appendChild(safeDiv);
      }
      const timestamp=new Date().toLocaleString();
      const timeDiv=document.createElement('div');
      timeDiv.style.cssText='text-align:center;margin-top:15px;font-size:0.8em;opacity:0.7;';
      timeDiv.textContent=`Analyzed on ${timestamp}`;
      resultsContent.appendChild(timeDiv);
    }

    function displayError(message){
      results.style.display='block';
      resultsContent.innerHTML=`<div class="result-item result-warning"><div style="font-size:1.2em;font-weight:bold;margin-bottom:10px;">‚ö†Ô∏è Analysis Error</div><div>${message}</div></div>`;
    }

    // Report Modal Logic
    function openReport(){ document.getElementById('reportModal').style.display='flex'; }
    function closeReport(){ document.getElementById('reportModal').style.display='none'; }
    function submitReport(){
      const text=document.getElementById('reportText').value.trim();
      if(!text){ alert("Please describe the incident before submitting."); return;}
      console.log("üö® Report Submitted:", text);
      alert("‚úÖ Thank you! Your report has been submitted.");
      document.getElementById('reportText').value=''; closeReport();
    }
  </script>
</body>
</html>
