<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🛡️ BullyGuard AI</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<style>
/* (Keep your same CSS from before) */
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">🛡️ Anti-Bullying AI</div>
    <div class="subtitle">Photo-based detection system</div>
  </div>

  <div class="camera-section">
    <div class="upload-area" id="upload-area">
      <div class="upload-icon">📸</div>
      <div class="upload-text">Tap to take photo or upload image</div>
    </div>
    <input type="file" id="file-input" accept="image/*">
    <button class="btn btn-camera" onclick="document.getElementById('file-input').click()">📷 Upload Image</button>
  </div>

  <div class="loading" id="loading" style="display:none;">
    <div class="spinner"></div>
    <div>🔍 Analyzing image...</div>
  </div>

  <div class="results-section" id="results" style="display:none;">
    <div class="results-title">📊 Detection Results</div>
    <div id="results-content"></div>
    <div id="report-section" style="display:none;">
      <button class="btn btn-report" onclick="reportToParents()">📤 Send Report</button>
    </div>
  </div>
</div>

<script>
// ==== Teachable Machine Setup ====
const URL = "https://teachablemachine.withgoogle.com/models/fJGp66m4p/";
let model, maxPredictions;

// Load the model
async function init() {
  const modelURL = URL + "model.json";
  const metadataURL = URL + "metadata.json";
  model = await tmImage.load(modelURL, metadataURL);
  maxPredictions = model.getTotalClasses();
}
init();

// Handle uploaded file
document.getElementById("file-input").addEventListener("change", e => {
  const file = e.target.files[0];
  if (file) analyzeImage(file);
});

async function analyzeImage(file) {
  document.getElementById("loading").style.display = "block";
  document.getElementById("results").style.display = "none";

  const img = document.createElement("img");
  img.src = URL.createObjectURL(file);
  img.onload = async () => {
    const prediction = await model.predict(img);
    let top = prediction.sort((a,b)=>b.probability - a.probability)[0];
    displayResult(top.className, top.probability);
    document.getElementById("loading").style.display = "none";
  };
}

function displayResult(label, prob) {
  const results = document.getElementById("results");
  const content = document.getElementById("results-content");
  const report = document.getElementById("report-section");
  results.style.display = "block";
  content.innerHTML = "";

  let div = document.createElement("div");
  if (label.toLowerCase().includes("bully")) {
    div.className = "result-item result-danger";
    div.innerHTML = `🚨 Bullying Detected! (Confidence: ${(prob*100).toFixed(1)}%)`;
    report.style.display = "block";
  } else if (label.toLowerCase().includes("kind")) {
    div.className = "result-item result-safe";
    div.innerHTML = `😊 Kindness Detected! (Confidence: ${(prob*100).toFixed(1)}%)`;
    report.style.display = "none";
  } else {
    div.className = "result-item";
    div.innerHTML = "ℹ️ No clear bullying/kindness detected.";
    report.style.display = "none";
  }

  content.appendChild(div);
}

// ==== Reporting ====
function reportToParents() {
  // Here you’d connect to backend (Node.js, Firebase, or EmailJS/Twilio)
  alert("📤 Report sent to parents via SMS/Email.");
}
</script>
</body>
</html>
